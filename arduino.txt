#include <Wire.h>
#include "RTClib.h"
#include "HX711.h"
#include <Servo.h>

#define DOUT_PIN 2   
#define CLK_PIN 3    

#define TRIG_PIN 4   
#define ECHO_PIN 5   
#define LED_PIN 6    

#define P_E 8   

Servo myservo;

HX711 scale;

RTC_Millis rtc;

int pos=0;
int speak=0;


void setup () {
    Serial.begin(9600);
    scale.begin(DOUT_PIN, CLK_PIN);
  
  Serial.println("Initializing...");

  float calibration_factor = 796.55; 

  scale.set_scale(calibration_factor);
  
  scale.tare();      
  pinMode(TRIG_PIN, OUTPUT);
  pinMode(ECHO_PIN, INPUT);
  pinMode(LED_PIN, OUTPUT);
  pinMode(P_E, OUTPUT); 
  myservo.attach(9);


    
  rtc.begin(DateTime(F(__DATE__), F(__TIME__)));
    
  rtc.adjust(DateTime(2023, 8, 24, 3, 29, 0));
}

void loop () {
  DateTime now = rtc.now();

  if (now.hour() == 3 && now.minute() >= 0 && now.minute() <= 30  || now.hour()==3 && now.minute() >=32 && now.minute() <=35 ) {

      
  long duration, distance_cm;
  
  digitalWrite(TRIG_PIN, LOW);
  delayMicroseconds(2);
  
  digitalWrite(TRIG_PIN, HIGH);
  delayMicroseconds(10);
  digitalWrite(TRIG_PIN, LOW);
  
  duration = pulseIn(ECHO_PIN, HIGH);
  
  distance_cm = (duration / 2) / 29.1;  
  
  Serial.print("Cat Distance: ");
  Serial.print(distance_cm);
  Serial.println(" cm");
  delay(2000);
  
  int threshold_distance = 10; 

  if (distance_cm > threshold_distance && speak == 0) {

    
    digitalWrite(P_E, HIGH);   
    delay(2000);                       
    digitalWrite(P_E, LOW);     
    delay(1000);
    
  }


  else if(distance_cm < threshold_distance){
    
    speak=1;

    digitalWrite(P_E, LOW);   

    if (scale.is_ready()) {
    float weight = scale.get_units(10); 
    Serial.print("Weight: ");
    Serial.print(weight);
    Serial.println(" grams");
    if (weight < 100){
        
      digitalWrite(LED_PIN, HIGH);  
      
      

      for (pos = 0; pos <= 180; pos += 1) { 
       
         myservo.write(pos);              
         delay(15);                       
    
      }
      for (pos = 180; pos >= 0; pos -= 1) { 
        myservo.write(pos);              
        delay(15);          
      }               
      
    }
    Serial.println("food is given");
    digitalWrite(LED_PIN, LOW);
    



  delay(1000);
  }

  } 
  

} 
    
  else 
  {
    Serial.println("its not time");
    delay(3000);
    speak=0;
  }
    
   
    
    
}
